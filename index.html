<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Volleyball Team Balancer</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%);
      min-height: 100vh;
      color: var(--slate-800);
      padding-bottom: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 12px; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      box-shadow: var(--shadow-lg);
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 50px; height: 50px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px;
    }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header p { font-size: 12px; opacity: 0.9; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    
    /* Buttons */
    .btn {
      padding: 8px 16px; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
      display: inline-flex; align-items: center; gap: 6px; font-size: 13px;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-white { background: white; color: var(--slate-700); }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
    .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-purple { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; }
    .btn-outline { background: white; border: 2px solid var(--slate-200); color: var(--slate-700); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    /* Sections */
    .section {
      background: white; border-radius: 16px;
      margin-bottom: 16px; box-shadow: var(--shadow); overflow: hidden;
    }
    .section-header {
      background: var(--slate-50); padding: 14px 16px;
      border-bottom: 1px solid var(--slate-200);
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 10px;
    }
    .section-title {
      font-size: 16px; font-weight: 700; color: var(--slate-800);
      display: flex; align-items: center; gap: 8px;
    }
    .section-content { padding: 16px; }
    
    /* Forms */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px; margin-bottom: 12px;
    }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-label { font-size: 12px; font-weight: 600; color: var(--slate-600); }
    .form-control {
      padding: 10px 12px; border: 2px solid var(--slate-200);
      border-radius: 8px; font-size: 14px; transition: all 0.2s; background: white;
    }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    
    /* Skills Grid */
    .skills-section { margin: 16px 0; }
    .skills-title { font-size: 14px; font-weight: 700; color: var(--slate-700); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .skills-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
    .skill-item { display: flex; flex-direction: column; gap: 4px; }
    .skill-header { display: flex; justify-content: space-between; align-items: center; }
    .skill-name { font-size: 12px; font-weight: 600; color: var(--slate-600); }
    .skill-value { font-size: 13px; font-weight: 700; color: var(--primary); min-width: 20px; text-align: right; }
    input[type="range"] {
      width: 100%; height: 6px; -webkit-appearance: none;
      background: linear-gradient(to right, var(--primary) 0%, var(--primary) var(--value, 50%), var(--slate-200) var(--value, 50%), var(--slate-200) 100%);
      border-radius: 3px; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px;
      background: white; border: 3px solid var(--primary);
      border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Checkbox */
    .checkbox-group { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--slate-50); border-radius: 8px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--success); }
    .checkbox-label { font-size: 13px; font-weight: 600; color: var(--slate-700); }
    
    /* Player Cards Grid */
    .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .player-card {
      background: white; border: 2px solid var(--slate-100);
      border-radius: 12px; overflow: hidden; transition: all 0.2s;
    }
    .player-card:hover { border-color: var(--primary); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .player-card-header {
      background: linear-gradient(135deg, var(--slate-50), white);
      padding: 12px; display: flex; justify-content: space-between;
      align-items: flex-start; border-bottom: 1px solid var(--slate-100);
    }
    .player-info h3 { font-size: 15px; font-weight: 700; color: var(--slate-800); margin-bottom: 4px; }
    .player-badges { display: flex; gap: 4px; flex-wrap: wrap; }
    .badge { padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: 700; }
    .badge-role { background: var(--primary); color: white; }
    .badge-available { background: var(--success); color: white; }
    .badge-unavailable { background: var(--slate-400); color: white; }
    .player-score { text-align: right; }
    .score-label { font-size: 10px; color: var(--slate-500); text-transform: uppercase; }
    .score-value {
      font-size: 22px; font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .player-details { padding: 8px 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; background: var(--slate-50); font-size: 11px; }
    .detail-item { text-align: center; }
    .detail-value { font-weight: 700; color: var(--slate-700); }
    .detail-label { color: var(--slate-500); font-size: 10px; }
    .player-skills { padding: 8px 12px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .mini-stat { text-align: center; }
    .mini-stat-value { font-size: 13px; font-weight: 700; color: var(--slate-700); }
    .mini-stat-label { font-size: 9px; color: var(--slate-500); text-transform: uppercase; }
    .player-actions { padding: 8px 12px; background: var(--slate-50); display: flex; gap: 6px; justify-content: flex-end; }
    
    /* Ranking Table */
    .ranking-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .ranking-table th { background: var(--slate-100); padding: 12px 8px; text-align: left; font-weight: 700; color: var(--slate-700); border-bottom: 2px solid var(--slate-200); }
    .ranking-table td { padding: 10px 8px; border-bottom: 1px solid var(--slate-100); }
    .ranking-table tr:hover { background: var(--slate-50); }
    .ranking-table .rank { font-weight: 700; width: 50px; }
    .ranking-table .player-name { font-weight: 600; }
    .ranking-table .overall { font-weight: 700; color: var(--primary); }
    .medal { font-size: 18px; }
    .rank-1 { background: linear-gradient(135deg, #fef3c7, #fde68a) !important; }
    .rank-2 { background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important; }
    .rank-3 { background: linear-gradient(135deg, #fed7aa, #fdba74) !important; }
    
    /* Team Balancer Section */
    .balance-controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .control-group { display: flex; align-items: center; gap: 6px; }
    .control-label { font-size: 12px; font-weight: 600; color: var(--slate-600); }
    
    .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-top: 16px; }
    .team-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
    .team-header {
      padding: 16px; color: white;
      display: flex; justify-content: space-between; align-items: center;
      position: relative; overflow: hidden;
    }
    .team-header::before {
      content: ''; position: absolute; top: -50%; right: -20%;
      width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;
    }
    .team-1 .team-header { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .team-2 .team-header { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
    .team-3 .team-header { background: linear-gradient(135deg, #10b981, #14b8a6); }
    .team-4 .team-header { background: linear-gradient(135deg, #f97316, #fbbf24); }
    .team-name { font-size: 22px; font-weight: 800; position: relative; z-index: 1; }
    .team-count { font-size: 13px; opacity: 0.9; }
    .team-avg { text-align: right; position: relative; z-index: 1; }
    .team-avg-label { font-size: 10px; opacity: 0.8; text-transform: uppercase; }
    .team-avg-score { font-size: 32px; font-weight: 800; line-height: 1; }
    
    .team-body { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .team-chart { display: flex; align-items: center; justify-content: center; }
    .team-chart canvas { max-width: 180px !important; max-height: 180px !important; }
    .team-roster-container { max-height: 250px; overflow-y: auto; }
    .roster-header { font-size: 12px; font-weight: 700; color: var(--slate-600); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .roster-count { background: var(--primary); color: white; padding: 2px 8px; border-radius: 99px; font-size: 11px; }
    
    .team-roster { display: flex; flex-direction: column; gap: 6px; }
    .roster-player {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 10px; background: var(--slate-50); border-radius: 8px;
      cursor: grab; transition: all 0.2s; border: 2px solid transparent;
      user-select: none;
    }
    .roster-player:hover { background: var(--slate-100); border-color: var(--primary); }
    .roster-player.dragging { 
      opacity: 0.4; 
      transform: scale(0.95); 
      border-color: var(--primary);
      background: var(--primary);
      cursor: grabbing;
    }
    .roster-player:active { cursor: grabbing; }
    .team-roster {
      display: flex; flex-direction: column; gap: 6px;
      min-height: 80px;
      padding: 8px;
      border-radius: 8px;
      border: 2px dashed transparent;
      transition: all 0.2s;
      background: #f8fafc;
    }
    .team-roster.drag-over {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.15);
    }
    .empty-roster-message {
      color: #94a3b8;
      text-align: center;
      padding: 20px;
      font-size: 13px;
      font-style: italic;
    }
    .roster-player-info { display: flex; align-items: center; gap: 8px; }
    .drag-handle { color: var(--slate-400); font-size: 14px; cursor: grab; }
    .roster-player-name { font-weight: 600; font-size: 13px; }
    .roster-player-role { font-size: 11px; color: var(--slate-500); }
    .roster-player-score { font-weight: 700; font-size: 15px; color: var(--primary); }
    
    /* Drag & Drop Info */
    .drag-info {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border: 2px solid var(--success); border-radius: 12px;
      padding: 12px 16px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .drag-info-icon { font-size: 32px; }
    .drag-info-text h4 { font-size: 14px; font-weight: 700; color: var(--slate-800); margin-bottom: 2px; }
    .drag-info-text p { font-size: 12px; color: var(--slate-600); }
    
    /* Distribution Strategies */
    .strategies-info {
      background: var(--slate-50); border-radius: 12px;
      padding: 16px; margin-top: 16px;
    }
    .strategies-title { font-size: 14px; font-weight: 700; color: var(--slate-700); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .strategy-item { margin-bottom: 8px; font-size: 13px; }
    .strategy-name { font-weight: 700; }
    .strategy-variance { color: var(--success); }
    .strategy-greedy { color: var(--warning); }
    .strategy-snake { color: var(--danger); }
    
    /* Skill Weights Section */
    .weights-section {
      background: linear-gradient(135deg, #faf5ff, #f3e8ff);
      border: 2px solid #e9d5ff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .weights-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .weights-title {
      font-size: 15px;
      font-weight: 700;
      color: #7c3aed;
    }
    .weights-actions {
      display: flex;
      gap: 8px;
    }
    .weights-panel {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e9d5ff;
    }
    .weights-description {
      font-size: 13px;
      color: var(--slate-600);
      margin-bottom: 16px;
    }
    .weights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .weight-item {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .weight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .weight-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--slate-700);
      text-transform: capitalize;
    }
    .weight-value {
      font-size: 14px;
      font-weight: 700;
      color: #7c3aed;
      min-width: 40px;
      text-align: right;
    }
    .weight-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: linear-gradient(to right, #7c3aed 0%, #7c3aed var(--weight-value, 50%), #e2e8f0 var(--weight-value, 50%), #e2e8f0 100%);
      border-radius: 4px;
      cursor: pointer;
    }
    .weight-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: white;
      border: 3px solid #7c3aed;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .weights-presets {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .preset-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--slate-600);
    }
    
    /* Team Comparison Section */
    .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .comparison-chart { display: flex; align-items: center; justify-content: center; }
    .comparison-chart canvas { max-width: 400px !important; max-height: 350px !important; }
    .comparison-stats { }
    .stats-title { font-size: 16px; font-weight: 700; color: var(--slate-800); margin-bottom: 16px; text-align: center; }
    .team-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; }
    .legend-color { width: 16px; height: 16px; border-radius: 4px; }
    .legend-team-1 { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .legend-team-2 { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
    
    .skill-comparison { margin-bottom: 12px; }
    .skill-comparison-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .skill-comparison-name { font-size: 13px; font-weight: 600; color: var(--slate-700); }
    .skill-bars { display: flex; gap: 4px; }
    .skill-bar-container { flex: 1; display: flex; align-items: center; gap: 6px; }
    .skill-bar { height: 10px; border-radius: 5px; transition: width 0.5s ease; }
    .skill-bar-1 { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
    .skill-bar-2 { background: linear-gradient(90deg, #8b5cf6, #ec4899); }
    .skill-bar-value { font-size: 12px; font-weight: 700; min-width: 30px; }
    .skill-bar-value-1 { color: #3b82f6; }
    .skill-bar-value-2 { color: #8b5cf6; }
    
    /* Report Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 9998;
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white; border-radius: 16px;
      max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    }
    .modal-header {
      padding: 16px 20px; background: var(--slate-50);
      border-bottom: 1px solid var(--slate-200);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-actions { display: flex; gap: 8px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--slate-500); }
    .modal-body { padding: 20px; max-height: calc(90vh - 80px); overflow-y: auto; }
    
    /* Report Styles */
    .report-header { text-align: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--primary); }
    .report-logo { font-size: 48px; margin-bottom: 8px; }
    .report-title { font-size: 24px; font-weight: 800; color: var(--slate-800); }
    .report-subtitle { font-size: 14px; color: var(--slate-500); }
    .report-date { font-size: 12px; color: var(--slate-400); margin-top: 8px; }
    
    .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .summary-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 16px; border-radius: 12px; text-align: center; }
    .summary-value { font-size: 28px; font-weight: 800; }
    .summary-label { font-size: 11px; text-transform: uppercase; opacity: 0.9; }
    
    .report-section { margin-bottom: 24px; }
    .report-section-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); }
    
    .report-team { background: var(--slate-50); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .report-team-header { font-weight: 700; margin-bottom: 8px; padding: 8px; border-radius: 6px; color: white; }
    .report-team-1 { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .report-team-2 { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
    .report-players { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
    .report-player { background: white; padding: 8px; border-radius: 6px; text-align: center; }
    .report-player-name { font-weight: 600; font-size: 13px; }
    .report-player-score { color: var(--primary); font-weight: 700; }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--slate-500); }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-text { font-size: 14px; }
    
    /* Toast */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
    .toast {
      background: var(--slate-800); color: white; padding: 12px 16px;
      border-radius: 8px; margin-top: 8px; box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 8px;
    }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Footer */
    .footer { text-align: center; padding: 20px; color: var(--slate-500); font-size: 12px; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header { flex-direction: column; text-align: center; }
      .header-left { flex-direction: column; }
      .form-row { grid-template-columns: 1fr 1fr; }
      .comparison-container { grid-template-columns: 1fr; }
      .team-body { grid-template-columns: 1fr; }
      .teams-grid { grid-template-columns: 1fr; }
      .ranking-table { font-size: 11px; }
      .ranking-table th, .ranking-table td { padding: 6px 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo">üèê</div>
        <div>
          <h1>Volleyball Team Balancer</h1>
          <p>Professional team management with smart balancing algorithms</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-white" onclick="exportData()">üì§ Export</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
        <button class="btn btn-white" onclick="document.getElementById('importFile').click()">üì• Import</button>
      </div>
    </header>
    
    <!-- Add Player Section -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title" id="formTitle">‚ûï Add New Player</h2>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-outline btn-sm" onclick="resetForm()">üîÑ Reset</button>
          <button class="btn btn-danger btn-sm" onclick="cancelEdit()" id="cancelBtn" style="display: none;">‚ùå Cancel</button>
        </div>
      </div>
      <div class="section-content">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" id="playerName" class="form-control" placeholder="Enter player name">
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select id="playerRole" class="form-control">
              <option value="OH">OH - Outside Hitter</option>
              <option value="OPP">OPP - Opposite</option>
              <option value="MB">MB - Middle Blocker</option>
              <option value="S">S - Setter</option>
              <option value="L">L - Libero</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Height (cm)</label>
            <input type="number" id="playerHeight" class="form-control" value="175" min="140" max="220">
          </div>
          <div class="form-group">
            <label class="form-label">Age</label>
            <input type="number" id="playerAge" class="form-control" value="25" min="10" max="60">
          </div>
          <div class="form-group">
            <label class="form-label">Experience (years)</label>
            <input type="number" id="playerExperience" class="form-control" value="3" min="0" max="30">
          </div>
          <div class="form-group">
            <label class="form-label">Dominant Hand</label>
            <select id="playerHand" class="form-control">
              <option value="Right">Right</option>
              <option value="Left">Left</option>
            </select>
          </div>
        </div>
        
        <div class="skills-section">
          <div class="skills-title">‚ö° Skills (0-10)</div>
          <div class="skills-grid" id="skillsInput"></div>
        </div>
        
        <div class="form-row" style="margin-top: 12px;">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Notes</label>
            <input type="text" id="playerNotes" class="form-control" placeholder="Optional notes about the player">
          </div>
        </div>
        <div class="checkbox-group" style="width: fit-content; margin-top: 8px;">
          <input type="checkbox" id="playerAvailable" checked>
          <label class="checkbox-label" for="playerAvailable">‚úÖ Available today</label>
        </div>
        
        <button class="btn btn-success" id="submitBtn" style="width: 100%; margin-top: 16px; padding: 14px;" onclick="addPlayer()">
          ‚ú® Add Player
        </button>
      </div>
    </section>
    
    <!-- Player Roster Section -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">üë• Player Roster (<span id="playerCount">0</span>)</h2>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-outline btn-sm" onclick="sortPlayers('name')">Sort by Name</button>
          <button class="btn btn-outline btn-sm" onclick="sortPlayers('score')">Sort by Score</button>
        </div>
      </div>
      <div class="section-content">
        <div class="players-grid" id="playersGrid"></div>
      </div>
    </section>
    
    <!-- Overall Ranking Section -->
    <section class="section" id="rankingSection" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">üèÜ Overall Ranking</h2>
      </div>
      <div class="section-content" style="overflow-x: auto;">
        <table class="ranking-table" id="rankingTable"></table>
      </div>
    </section>
    
    <!-- Team Balancer Section -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">‚öñÔ∏è Team Balancer</h2>
        <div class="balance-controls">
          <div class="control-group">
            <select id="strategy" class="form-control" style="width: auto;">
              <option value="variance">‚öñÔ∏è Variance Minimization</option>
              <option value="greedy">‚ö° Greedy Round-Robin</option>
              <option value="snake">üêç Snake Draft</option>
            </select>
          </div>
          <div class="control-group">
            <label class="control-label">Teams:</label>
            <input type="number" id="numTeams" class="form-control" value="2" min="2" max="4" style="width: 60px;">
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="presentOnly" checked>
            <label class="checkbox-label" for="presentOnly">Present only</label>
          </div>
          <button class="btn btn-primary" onclick="balanceTeams()">üéØ Distribute</button>
        </div>
      </div>
      <div class="section-content">
        <!-- Skill Weights Section -->
        <div class="weights-section">
          <div class="weights-header">
            <div class="weights-title">üéöÔ∏è Skill Weights</div>
            <div class="weights-actions">
              <button class="btn btn-outline btn-sm" onclick="toggleWeightsPanel()">
                <span id="weightsToggleIcon">‚ñ∂</span> Customize
              </button>
              <button class="btn btn-outline btn-sm" onclick="resetWeights()">‚Ü∫ Reset</button>
            </div>
          </div>
          <div class="weights-panel" id="weightsPanel" style="display: none;">
            <p class="weights-description">Adjust how much each skill affects team balancing. Higher weight = more important.</p>
            <div class="weights-grid" id="weightsGrid"></div>
            <div class="weights-presets">
              <span class="preset-label">Presets:</span>
              <button class="btn btn-sm btn-outline" onclick="applyPreset('balanced')">‚öñÔ∏è Balanced</button>
              <button class="btn btn-sm btn-outline" onclick="applyPreset('offensive')">‚öîÔ∏è Offensive</button>
              <button class="btn btn-sm btn-outline" onclick="applyPreset('defensive')">üõ°Ô∏è Defensive</button>
              <button class="btn btn-sm btn-outline" onclick="applyPreset('setter')">üéØ Setter-Focus</button>
            </div>
          </div>
        </div>
        
        <div class="drag-info" id="dragInfo" style="display: none;">
          <div class="drag-info-icon">üéØ</div>
          <div class="drag-info-text">
            <h4>Drag & Drop to Fine-Tune</h4>
            <p>Drag players between teams to manually adjust the rosters. Look for the ‚ãÆ‚ãÆ icon to grab players.</p>
          </div>
        </div>
        
        <div class="teams-grid" id="teamsGrid">
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">‚öñÔ∏è</div>
            <p class="empty-text">Add players and click "Distribute" to create fair teams</p>
          </div>
        </div>
        
        <div class="strategies-info">
          <div class="strategies-title">üí° Distribution Strategies</div>
          <div class="strategy-item">
            <span class="strategy-name strategy-variance">‚öñÔ∏è Variance Minimization:</span>
            Intelligent algorithm that minimizes skill variance. Best for balanced competitive matches.
          </div>
          <div class="strategy-item">
            <span class="strategy-name strategy-greedy">‚ö° Greedy Round-Robin:</span>
            Fast distribution that spreads top players evenly. Great for quick casual games.
          </div>
          <div class="strategy-item">
            <span class="strategy-name strategy-snake">üêç Snake Draft:</span>
            Simulates captain-style picking. Ideal for tournament-style team formation.
          </div>
        </div>
      </div>
    </section>
    
    <!-- Team Comparison Section -->
    <section class="section" id="comparisonSection" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">üìä Team Comparison</h2>
        <button class="btn btn-purple" onclick="generateReport()">üìÑ Generate Report</button>
      </div>
      <div class="section-content">
        <div class="comparison-container">
          <div class="comparison-chart">
            <canvas id="comparisonRadar"></canvas>
          </div>
          <div class="comparison-stats">
            <div class="stats-title">Team Statistics</div>
            <div class="team-legend" id="teamLegend"></div>
            <div id="skillComparisons"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Footer -->
    <footer class="footer">
      <p>¬© 2025 DaenAI. All rights reserved.</p>
      <p>Contact: majid.mazouchi@gmail.com</p>
    </footer>
  </div>
  
  <!-- Report Modal -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üìÑ Team Report</div>
        <div class="modal-actions">
          <button class="btn btn-primary btn-sm" onclick="printReport()">üñ®Ô∏è Print</button>
          <button class="btn btn-success btn-sm" onclick="downloadReport()">üì• Download</button>
          <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body" id="reportContent"></div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>
  
  <script>
    // Telegram WebApp Integration
    const tg = window.Telegram?.WebApp;
    if (tg) { 
      try { tg.ready(); } catch(e) {}
      try { tg.expand(); } catch(e) {}
    }
    
    // Constants
    const SKILLS = ['serve', 'pass', 'set', 'attack', 'block', 'defense', 'speed', 'stamina'];
    const TEAM_COLORS = [
      { bg: 'rgba(59,130,246,0.2)', border: 'rgb(59,130,246)', gradient: ['#3b82f6', '#06b6d4'] },
      { bg: 'rgba(139,92,246,0.2)', border: 'rgb(139,92,246)', gradient: ['#8b5cf6', '#ec4899'] },
      { bg: 'rgba(16,185,129,0.2)', border: 'rgb(16,185,129)', gradient: ['#10b981', '#14b8a6'] },
      { bg: 'rgba(249,115,22,0.2)', border: 'rgb(249,115,22)', gradient: ['#f97316', '#fbbf24'] }
    ];
    
    // Default skill weights
    const DEFAULT_WEIGHTS = {
      serve: 1.0, pass: 1.0, set: 1.0, attack: 1.0,
      block: 1.0, defense: 1.0, speed: 1.0, stamina: 1.0
    };
    
    // State
    let players = [];
    let teams = [];
    let skillWeights = { ...DEFAULT_WEIGHTS };
    let editingPlayerId = null;
    let sortField = 'score';
    let sortDirection = 'desc';
    let comparisonChart = null;
    let teamCharts = {};
    let draggedPlayer = null;
    let draggedFromTeam = null;
    
    // Initialize
    function init() {
      try {
        loadData();
        renderSkillInputs();
        renderWeightsGrid();
        renderPlayers();
        renderRanking();
      } catch(e) {
        console.error('Init error:', e);
      }
    }
    
    // Data Persistence
    function loadData() {
      // Load players
      const saved = localStorage.getItem('vb:players');
      if (saved) {
        try { 
          players = JSON.parse(saved).map(p => migratePlayer(p));
        } catch(e) {
          console.error('Load error:', e);
        }
      }
      
      // Load skill weights
      const savedWeights = localStorage.getItem('vb:weights');
      if (savedWeights) {
        try {
          const loaded = JSON.parse(savedWeights);
          skillWeights = { ...DEFAULT_WEIGHTS, ...loaded };
        } catch(e) {
          skillWeights = { ...DEFAULT_WEIGHTS };
        }
      }
      
      // Try Telegram Cloud Storage (only if available and supported)
      try {
        if (tg && tg.CloudStorage && typeof tg.CloudStorage.getItem === 'function') {
          tg.CloudStorage.getItem('players', (err, value) => {
            if (!err && value) {
              try {
                let cloudPlayers = JSON.parse(value).map(p => migratePlayer(p));
                if (cloudPlayers.length > players.length) {
                  players = cloudPlayers;
                  renderPlayers();
                  renderRanking();
                }
              } catch(e) {}
            }
          });
        }
      } catch(e) {
        // CloudStorage not available, ignore
        console.log('Telegram CloudStorage not available');
      }
    }
    
    function migratePlayer(p) {
      if (!p.skills) { p.skills = {}; SKILLS.forEach(s => p.skills[s] = 5); }
      if (!p.id) p.id = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      if (!p.height) p.height = 175;
      if (!p.age) p.age = 25;
      if (!p.experience) p.experience = 3;
      if (!p.hand) p.hand = 'Right';
      if (p.available === undefined) p.available = true;
      p.overall = calculateOverall(p);
      return p;
    }
    
    function calculateOverall(player) {
      const skills = player.skills || {};
      
      // Calculate weighted skill average
      let weightedSum = 0;
      let totalWeight = 0;
      SKILLS.forEach(s => {
        const skillValue = skills[s] || 5;
        const weight = skillWeights[s] || 1.0;
        weightedSum += skillValue * weight;
        totalWeight += weight;
      });
      const skillAvg = totalWeight > 0 ? weightedSum / totalWeight : 5;
      
      // Physical attributes (unchanged - no weights applied)
      const height = player.height || 175;
      const age = player.age || 25;
      const experience = player.experience || 3;
      const heightScore = Math.min(10, Math.max(0, (height - 150) / 5));
      const ageScore = age >= 20 && age <= 35 ? 10 : (age < 20 ? age / 2 : Math.max(0, 10 - (age - 35) / 3));
      const expScore = Math.min(10, experience / 1.5);
      
      // Combine: 70% skills, 30% physical
      return ((skillAvg * 0.7) + ((heightScore + ageScore + expScore) / 3 * 0.3)).toFixed(2);
    }
    
    function saveData() {
      localStorage.setItem('vb:players', JSON.stringify(players));
      localStorage.setItem('vb:weights', JSON.stringify(skillWeights));
      // Try Telegram Cloud Storage (only if available)
      try {
        if (tg && tg.CloudStorage && typeof tg.CloudStorage.setItem === 'function') {
          tg.CloudStorage.setItem('players', JSON.stringify(players));
        }
      } catch(e) {
        // CloudStorage not available, ignore
      }
    }
    
    // ==================== SKILL WEIGHTS ====================
    
    function renderWeightsGrid() {
      const container = document.getElementById('weightsGrid');
      if (!container) return;
      
      container.innerHTML = SKILLS.map(skill => {
        const weight = skillWeights[skill] || 1.0;
        const percentage = (weight / 2) * 100;
        return `
          <div class="weight-item">
            <div class="weight-header">
              <span class="weight-name">${capitalize(skill)}</span>
              <span class="weight-value" id="weightVal_${skill}">${weight.toFixed(1)}x</span>
            </div>
            <input type="range" class="weight-slider" 
              min="0" max="2" step="0.1" value="${weight}"
              id="weight_${skill}"
              style="--weight-value: ${percentage}%"
              oninput="updateWeight('${skill}', this.value)">
          </div>
        `;
      }).join('');
    }
    
    function updateWeight(skill, value) {
      const weight = parseFloat(value);
      skillWeights[skill] = weight;
      
      // Update display
      const valueEl = document.getElementById(`weightVal_${skill}`);
      const sliderEl = document.getElementById(`weight_${skill}`);
      if (valueEl) valueEl.textContent = weight.toFixed(1) + 'x';
      if (sliderEl) sliderEl.style.setProperty('--weight-value', (weight / 2 * 100) + '%');
      
      // Recalculate all player scores
      players.forEach(p => {
        p.overall = calculateOverall(p);
      });
      
      // Save and update UI
      saveData();
      renderPlayers();
      renderRanking();
      
      // If teams are already created, recalculate
      if (teams.length > 0 && teams[0].players.length > 0) {
        teams.forEach(t => {
          t.players.forEach(p => {
            const original = players.find(op => op.id === p.id);
            if (original) p.overall = original.overall;
          });
          t.total = t.players.reduce((s, p) => s + parseFloat(p.overall), 0);
        });
        renderTeams();
        renderComparison();
      }
    }
    
    function toggleWeightsPanel() {
      const panel = document.getElementById('weightsPanel');
      const icon = document.getElementById('weightsToggleIcon');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.textContent = '‚ñº';
      } else {
        panel.style.display = 'none';
        icon.textContent = '‚ñ∂';
      }
    }
    
    function resetWeights() {
      skillWeights = { ...DEFAULT_WEIGHTS };
      renderWeightsGrid();
      
      // Recalculate all scores
      players.forEach(p => {
        p.overall = calculateOverall(p);
      });
      
      saveData();
      renderPlayers();
      renderRanking();
      
      if (teams.length > 0 && teams[0].players.length > 0) {
        teams.forEach(t => {
          t.players.forEach(p => {
            const original = players.find(op => op.id === p.id);
            if (original) p.overall = original.overall;
          });
          t.total = t.players.reduce((s, p) => s + parseFloat(p.overall), 0);
        });
        renderTeams();
        renderComparison();
      }
      
      showToast('Weights reset to default', 'success');
    }
    
    function applyPreset(preset) {
      const presets = {
        balanced: { serve: 1.0, pass: 1.0, set: 1.0, attack: 1.0, block: 1.0, defense: 1.0, speed: 1.0, stamina: 1.0 },
        offensive: { serve: 1.2, pass: 0.8, set: 1.0, attack: 1.5, block: 0.8, defense: 0.7, speed: 1.3, stamina: 0.9 },
        defensive: { serve: 0.8, pass: 1.4, set: 1.0, attack: 0.8, block: 1.3, defense: 1.5, speed: 1.0, stamina: 1.2 },
        setter: { serve: 0.9, pass: 1.3, set: 1.8, attack: 0.6, block: 0.7, defense: 1.2, speed: 1.2, stamina: 1.0 }
      };
      
      const presetNames = {
        balanced: '‚öñÔ∏è Balanced',
        offensive: '‚öîÔ∏è Offensive',
        defensive: 'üõ°Ô∏è Defensive',
        setter: 'üéØ Setter-Focus'
      };
      
      if (presets[preset]) {
        skillWeights = { ...presets[preset] };
        renderWeightsGrid();
        
        // Recalculate all scores
        players.forEach(p => {
          p.overall = calculateOverall(p);
        });
        
        saveData();
        renderPlayers();
        renderRanking();
        
        if (teams.length > 0 && teams[0].players.length > 0) {
          teams.forEach(t => {
            t.players.forEach(p => {
              const original = players.find(op => op.id === p.id);
              if (original) p.overall = original.overall;
            });
            t.total = t.players.reduce((s, p) => s + parseFloat(p.overall), 0);
          });
          renderTeams();
          renderComparison();
        }
        
        showToast(`Applied ${presetNames[preset]} preset`, 'success');
      }
    }
    
    // Render Skill Inputs
    function renderSkillInputs() {
      document.getElementById('skillsInput').innerHTML = SKILLS.map(skill => `
        <div class="skill-item">
          <div class="skill-header">
            <span class="skill-name">${capitalize(skill)}</span>
            <span class="skill-value" id="val_${skill}">5</span>
          </div>
          <input type="range" min="0" max="10" value="5" id="skill_${skill}"
            style="--value: 50%"
            oninput="updateSkillSlider(this, '${skill}')">
        </div>
      `).join('');
    }
    
    function updateSkillSlider(input, skill) {
      const value = input.value;
      document.getElementById(`val_${skill}`).textContent = value;
      input.style.setProperty('--value', (value * 10) + '%');
    }
    
    function resetForm() {
      document.getElementById('playerName').value = '';
      document.getElementById('playerRole').value = 'OH';
      document.getElementById('playerHeight').value = '175';
      document.getElementById('playerAge').value = '25';
      document.getElementById('playerExperience').value = '3';
      document.getElementById('playerHand').value = 'Right';
      document.getElementById('playerNotes').value = '';
      document.getElementById('playerAvailable').checked = true;
      SKILLS.forEach(skill => {
        const input = document.getElementById(`skill_${skill}`);
        input.value = 5;
        document.getElementById(`val_${skill}`).textContent = '5';
        input.style.setProperty('--value', '50%');
      });
    }
    
    function cancelEdit() {
      editingPlayerId = null;
      resetForm();
      document.getElementById('formTitle').innerHTML = '‚ûï Add New Player';
      document.getElementById('submitBtn').innerHTML = '‚ú® Add Player';
      document.getElementById('cancelBtn').style.display = 'none';
    }
    
    // Add/Edit Player
    function addPlayer() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) { showToast('Please enter a player name', 'error'); return; }
      
      const skills = {};
      SKILLS.forEach(s => skills[s] = parseInt(document.getElementById(`skill_${s}`).value));
      
      const playerData = {
        name,
        role: document.getElementById('playerRole').value,
        height: parseInt(document.getElementById('playerHeight').value),
        age: parseInt(document.getElementById('playerAge').value),
        experience: parseInt(document.getElementById('playerExperience').value),
        hand: document.getElementById('playerHand').value,
        notes: document.getElementById('playerNotes').value,
        available: document.getElementById('playerAvailable').checked,
        skills
      };
      
      if (editingPlayerId) {
        const index = players.findIndex(p => p.id === editingPlayerId);
        if (index !== -1) {
          playerData.id = editingPlayerId;
          playerData.overall = calculateOverall(playerData);
          players[index] = playerData;
          showToast(`${name} updated!`, 'success');
        }
        editingPlayerId = null;
        document.getElementById('formTitle').innerHTML = '‚ûï Add New Player';
        document.getElementById('submitBtn').innerHTML = '‚ú® Add Player';
        document.getElementById('cancelBtn').style.display = 'none';
      } else {
        playerData.id = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        playerData.overall = calculateOverall(playerData);
        players.push(playerData);
        showToast(`${name} added!`, 'success');
      }
      
      saveData();
      renderPlayers();
      renderRanking();
      resetForm();
      try { if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
    }
    
    function editPlayer(id) {
      const player = players.find(p => p.id === id);
      if (!player) return;
      editingPlayerId = id;
      document.getElementById('playerName').value = player.name || '';
      document.getElementById('playerRole').value = player.role || 'OH';
      document.getElementById('playerHeight').value = player.height || 175;
      document.getElementById('playerAge').value = player.age || 25;
      document.getElementById('playerExperience').value = player.experience || 3;
      document.getElementById('playerHand').value = player.hand || 'Right';
      document.getElementById('playerNotes').value = player.notes || '';
      document.getElementById('playerAvailable').checked = player.available !== false;
      SKILLS.forEach(skill => {
        const value = player.skills?.[skill] || 5;
        const input = document.getElementById(`skill_${skill}`);
        input.value = value;
        document.getElementById(`val_${skill}`).textContent = value;
        input.style.setProperty('--value', (value * 10) + '%');
      });
      document.getElementById('formTitle').innerHTML = '‚úèÔ∏è Edit Player: ' + escapeHtml(player.name);
      document.getElementById('submitBtn').innerHTML = 'üíæ Save Changes';
      document.getElementById('cancelBtn').style.display = 'inline-flex';
      document.querySelector('.section').scrollIntoView({ behavior: 'smooth' });
    }
    
    function deletePlayer(id) {
      const doDelete = () => {
        players = players.filter(p => p.id !== id);
        saveData();
        renderPlayers();
        renderRanking();
        showToast('Player removed', 'success');
      };
      try {
        if (tg && tg.showConfirm) tg.showConfirm('Remove this player?', (ok) => { if (ok) doDelete(); });
        else if (confirm('Remove this player?')) doDelete();
      } catch(e) {
        if (confirm('Remove this player?')) doDelete();
      }
    }
    
    function toggleAvailability(id) {
      const player = players.find(p => p.id === id);
      if (player) {
        player.available = !player.available;
        saveData();
        renderPlayers();
      }
    }
    
    function sortPlayers(field) {
      if (sortField === field) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      else { sortField = field; sortDirection = field === 'name' ? 'asc' : 'desc'; }
      renderPlayers();
    }
    
    // Render Players
    function renderPlayers() {
      document.getElementById('playerCount').textContent = players.length;
      const grid = document.getElementById('playersGrid');
      
      if (players.length === 0) {
        grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-icon">üèê</div><p class="empty-text">No players yet. Add your team members above!</p></div>`;
        return;
      }
      
      const sorted = [...players].sort((a, b) => {
        let compare = sortField === 'name' ? a.name.localeCompare(b.name) : parseFloat(b.overall) - parseFloat(a.overall);
        return sortDirection === 'asc' ? compare : -compare;
      });
      
      grid.innerHTML = sorted.map(p => `
        <div class="player-card">
          <div class="player-card-header">
            <div class="player-info">
              <h3>${escapeHtml(p.name)}</h3>
              <div class="player-badges">
                <span class="badge badge-role">${p.role}</span>
                <span class="badge ${p.available ? 'badge-available' : 'badge-unavailable'}">${p.available ? '‚úì Available' : '‚úó Away'}</span>
              </div>
            </div>
            <div class="player-score">
              <div class="score-label">Overall</div>
              <div class="score-value">${p.overall}</div>
            </div>
          </div>
          <div class="player-details">
            <div class="detail-item"><div class="detail-value">${p.height || '-'}cm</div><div class="detail-label">Height</div></div>
            <div class="detail-item"><div class="detail-value">${p.age || '-'}</div><div class="detail-label">Age</div></div>
            <div class="detail-item"><div class="detail-value">${p.experience || 0}yr</div><div class="detail-label">Exp</div></div>
          </div>
          <div class="player-skills">
            ${SKILLS.map(s => `<div class="mini-stat"><div class="mini-stat-value">${p.skills?.[s] || 5}</div><div class="mini-stat-label">${s.substr(0,3)}</div></div>`).join('')}
          </div>
          <div class="player-actions">
            <button class="btn btn-primary btn-sm" onclick="editPlayer('${p.id}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-outline btn-sm" onclick="toggleAvailability('${p.id}')">${p.available ? '‚ùå' : '‚úÖ'}</button>
            <button class="btn btn-danger btn-sm" onclick="deletePlayer('${p.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }
    
    // Render Ranking Table
    function renderRanking() {
      const section = document.getElementById('rankingSection');
      const table = document.getElementById('rankingTable');
      
      if (players.length < 2) { section.style.display = 'none'; return; }
      section.style.display = 'block';
      
      const sorted = [...players].sort((a, b) => parseFloat(b.overall) - parseFloat(a.overall));
      
      table.innerHTML = `
        <thead>
          <tr>
            <th>#</th>
            <th>Player</th>
            <th>Role</th>
            <th>Overall</th>
            ${SKILLS.map(s => `<th>${capitalize(s)}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${sorted.map((p, i) => `
            <tr class="${i < 3 ? 'rank-' + (i+1) : ''}">
              <td class="rank">${i === 0 ? '<span class="medal">ü•á</span>' : i === 1 ? '<span class="medal">ü•à</span>' : i === 2 ? '<span class="medal">ü•â</span>' : i + 1}</td>
              <td class="player-name">${escapeHtml(p.name)}</td>
              <td><span class="badge badge-role">${p.role}</span></td>
              <td class="overall">${p.overall}</td>
              ${SKILLS.map(s => `<td>${p.skills?.[s] || 5}</td>`).join('')}
            </tr>
          `).join('')}
        </tbody>
      `;
    }
    
    // Balance Teams
    function balanceTeams() {
      const presentOnly = document.getElementById('presentOnly').checked;
      const availablePlayers = presentOnly ? players.filter(p => p.available) : [...players];
      
      if (availablePlayers.length < 2) {
        showToast('Need at least 2 players', 'error');
        return;
      }
      
      const numTeams = parseInt(document.getElementById('numTeams').value);
      const strategy = document.getElementById('strategy').value;
      
      teams = Array.from({ length: numTeams }, (_, i) => ({ number: i + 1, players: [], total: 0 }));
      const sorted = [...availablePlayers].sort((a, b) => parseFloat(b.overall) - parseFloat(a.overall));
      
      if (strategy === 'snake') {
        let dir = 1, idx = 0;
        sorted.forEach(p => {
          teams[idx].players.push(p);
          teams[idx].total += parseFloat(p.overall);
          idx += dir;
          if (idx >= numTeams || idx < 0) { dir *= -1; idx += dir; }
        });
      } else {
        sorted.forEach(p => {
          const minTeam = teams.reduce((m, t) => t.total < m.total ? t : m);
          minTeam.players.push(p);
          minTeam.total += parseFloat(p.overall);
        });
        if (strategy === 'variance') {
          for (let i = 0; i < 1500; i++) {
            const t1 = Math.floor(Math.random() * numTeams);
            const t2 = Math.floor(Math.random() * numTeams);
            if (t1 === t2 || !teams[t1].players.length || !teams[t2].players.length) continue;
            const p1 = Math.floor(Math.random() * teams[t1].players.length);
            const p2 = Math.floor(Math.random() * teams[t2].players.length);
            const oldVar = calcVariance();
            [teams[t1].players[p1], teams[t2].players[p2]] = [teams[t2].players[p2], teams[t1].players[p1]];
            teams.forEach(t => t.total = t.players.reduce((s, p) => s + parseFloat(p.overall), 0));
            if (calcVariance() > oldVar) {
              [teams[t1].players[p1], teams[t2].players[p2]] = [teams[t2].players[p2], teams[t1].players[p1]];
              teams.forEach(t => t.total = t.players.reduce((s, p) => s + parseFloat(p.overall), 0));
            }
          }
        }
      }
      
      renderTeams();
      renderComparison();
      showToast('Teams balanced!', 'success');
    }
    
    function calcVariance() {
      const avgs = teams.map(t => t.players.length ? t.total / t.players.length : 0);
      const mean = avgs.reduce((a, b) => a + b, 0) / avgs.length;
      return avgs.reduce((s, a) => s + Math.pow(a - mean, 2), 0);
    }
    
    // Render Teams with Drag & Drop and Radar Charts
    function renderTeams() {
      const grid = document.getElementById('teamsGrid');
      const dragInfo = document.getElementById('dragInfo');
      
      // Show empty state only if no teams at all
      if (teams.length === 0) {
        grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-icon">‚öñÔ∏è</div><p class="empty-text">Add players and click "Distribute" to create fair teams</p></div>`;
        dragInfo.style.display = 'none';
        return;
      }
      
      // Check if all teams are empty
      const totalPlayers = teams.reduce((sum, t) => sum + t.players.length, 0);
      if (totalPlayers === 0) {
        grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-icon">‚öñÔ∏è</div><p class="empty-text">Add players and click "Distribute" to create fair teams</p></div>`;
        dragInfo.style.display = 'none';
        return;
      }
      
      dragInfo.style.display = 'flex';
      
      grid.innerHTML = teams.map((team, idx) => {
        const avg = team.players.length ? (team.total / team.players.length).toFixed(2) : '0.00';
        const playersHtml = team.players.length > 0 
          ? team.players.map(p => `
              <div class="roster-player" draggable="true" data-player-id="${p.id}"
                ondragstart="handleDragStart(event, '${p.id}', ${idx})"
                ondragend="handleDragEnd(event)">
                <div class="roster-player-info">
                  <span class="drag-handle">‚ãÆ‚ãÆ</span>
                  <div>
                    <span class="roster-player-name">${escapeHtml(p.name)}</span>
                    <span class="roster-player-role">${p.role}</span>
                  </div>
                </div>
                <span class="roster-player-score">${p.overall}</span>
              </div>
            `).join('')
          : `<div class="empty-roster-message">Drop players here</div>`;
        
        return `
          <div class="team-card team-${idx + 1}" data-team="${idx}">
            <div class="team-header">
              <div>
                <div class="team-name">Team ${team.number}</div>
                <div class="team-count">${team.players.length} players</div>
              </div>
              <div class="team-avg">
                <div class="team-avg-label">Avg Score</div>
                <div class="team-avg-score">${avg}</div>
              </div>
            </div>
            <div class="team-body">
              <div class="team-chart">
                <canvas id="teamChart${idx}" width="180" height="180"></canvas>
              </div>
              <div class="team-roster-container">
                <div class="roster-header">
                  <span>ROSTER</span>
                  <span class="roster-count">${team.players.length}</span>
                </div>
                <div class="team-roster" id="roster-${idx}" data-team="${idx}" 
                  ondragover="handleDragOver(event)" 
                  ondragleave="handleDragLeave(event)"
                  ondrop="handleDrop(event, ${idx})">
                  ${playersHtml}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Render team radar charts
      setTimeout(() => {
        teams.forEach((team, idx) => renderTeamChart(team, idx));
      }, 100);
    }
    
    // Drag & Drop Handlers
    function handleDragStart(event, playerId, teamIdx) {
      draggedPlayer = playerId;
      draggedFromTeam = teamIdx;
      event.target.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', playerId); // Required for Firefox
    }
    
    function handleDragEnd(event) {
      event.target.classList.remove('dragging');
      // Remove all drag-over highlights
      document.querySelectorAll('.team-roster').forEach(el => el.classList.remove('drag-over'));
      // Reset state after a small delay to ensure drop completes
      setTimeout(() => {
        draggedPlayer = null;
        draggedFromTeam = null;
      }, 50);
    }
    
    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      // Highlight the drop zone
      const roster = event.currentTarget;
      if (roster && !roster.classList.contains('drag-over')) {
        roster.classList.add('drag-over');
      }
    }
    
    function handleDragLeave(event) {
      const roster = event.currentTarget;
      if (roster) roster.classList.remove('drag-over');
    }
    
    function handleDrop(event, targetTeamIdx) {
      event.preventDefault();
      
      // Reset drop zone highlight
      document.querySelectorAll('.team-roster').forEach(el => el.classList.remove('drag-over'));
      
      // Get player ID from dataTransfer as backup
      const playerIdFromData = event.dataTransfer.getData('text/plain');
      const playerId = draggedPlayer || playerIdFromData;
      const fromTeam = draggedFromTeam;
      
      if (!playerId || fromTeam === null || fromTeam === undefined || fromTeam === targetTeamIdx) {
        draggedPlayer = null;
        draggedFromTeam = null;
        return;
      }
      
      // Find and move player
      const playerIdx = teams[fromTeam].players.findIndex(p => p.id === playerId);
      if (playerIdx === -1) {
        draggedPlayer = null;
        draggedFromTeam = null;
        return;
      }
      
      const player = teams[fromTeam].players.splice(playerIdx, 1)[0];
      teams[targetTeamIdx].players.push(player);
      
      // Recalculate totals
      teams.forEach(t => t.total = t.players.reduce((s, p) => s + parseFloat(p.overall), 0));
      
      // Reset drag state before re-render
      draggedPlayer = null;
      draggedFromTeam = null;
      
      renderTeams();
      renderComparison();
      showToast(`${player.name} moved to Team ${targetTeamIdx + 1}`, 'success');
    }
    
    // Render Team Radar Chart
    function renderTeamChart(team, idx) {
      const canvas = document.getElementById(`teamChart${idx}`);
      if (!canvas) return;
      
      if (teamCharts[idx]) teamCharts[idx].destroy();
      
      const avgSkills = SKILLS.map(skill => {
        const values = team.players.map(p => p.skills?.[skill] || 5);
        return values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
      });
      
      teamCharts[idx] = new Chart(canvas, {
        type: 'radar',
        data: {
          labels: SKILLS.map(s => capitalize(s)),
          datasets: [{
            data: avgSkills,
            backgroundColor: TEAM_COLORS[idx].bg,
            borderColor: TEAM_COLORS[idx].border,
            borderWidth: 2,
            pointBackgroundColor: TEAM_COLORS[idx].border
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { display: false } },
          scales: {
            r: {
              beginAtZero: true,
              max: 10,
              ticks: { stepSize: 2, font: { size: 8 } },
              pointLabels: { font: { size: 9 } }
            }
          }
        }
      });
    }
    
    // Render Comparison Section
    function renderComparison() {
      const section = document.getElementById('comparisonSection');
      if (teams.length < 2 || teams[0].players.length === 0) {
        section.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      
      // Team Legend
      document.getElementById('teamLegend').innerHTML = teams.map((t, i) => {
        const avg = t.players.length ? (t.total / t.players.length).toFixed(2) : '0';
        return `<div class="legend-item"><div class="legend-color legend-team-${i+1}"></div>Team ${t.number} (${avg})</div>`;
      }).join('');
      
      // Skill Comparisons
      const comparisons = document.getElementById('skillComparisons');
      comparisons.innerHTML = SKILLS.map(skill => {
        const values = teams.map(t => {
          const vals = t.players.map(p => p.skills?.[skill] || 5);
          return vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(1) : '0';
        });
        return `
          <div class="skill-comparison">
            <div class="skill-comparison-header">
              <span class="skill-comparison-name">${capitalize(skill)}</span>
            </div>
            <div class="skill-bars">
              ${values.map((v, i) => `
                <div class="skill-bar-container">
                  <div class="skill-bar skill-bar-${i+1}" style="width: ${v * 10}%;"></div>
                  <span class="skill-bar-value skill-bar-value-${i+1}">${v}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      // Comparison Radar Chart
      renderComparisonChart();
    }
    
    function renderComparisonChart() {
      const canvas = document.getElementById('comparisonRadar');
      if (comparisonChart) comparisonChart.destroy();
      
      const datasets = teams.map((team, idx) => {
        const avgSkills = SKILLS.map(skill => {
          const values = team.players.map(p => p.skills?.[skill] || 5);
          return values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
        });
        return {
          label: `Team ${team.number}`,
          data: avgSkills,
          backgroundColor: TEAM_COLORS[idx].bg,
          borderColor: TEAM_COLORS[idx].border,
          borderWidth: 2,
          pointBackgroundColor: TEAM_COLORS[idx].border
        };
      });
      
      comparisonChart = new Chart(canvas, {
        type: 'radar',
        data: { labels: SKILLS.map(s => capitalize(s)), datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: 'Skill Comparison Overlay', font: { size: 16, weight: 'bold' } }
          },
          scales: {
            r: { beginAtZero: true, max: 10, ticks: { stepSize: 2 } }
          }
        }
      });
    }
    
    // Report Generation
    function generateReport() {
      const content = document.getElementById('reportContent');
      const variance = calcVariance();
      const balanceScore = Math.max(0, 100 - variance * 50).toFixed(0);
      const totalPlayers = teams.reduce((s, t) => s + t.players.length, 0);
      const avgScore = teams.reduce((s, t) => s + t.total, 0) / totalPlayers;
      
      content.innerHTML = `
        <div class="report-header">
          <div class="report-logo">üèê</div>
          <div class="report-title">Volleyball Team Report</div>
          <div class="report-subtitle">Professional Team Balancing Results</div>
          <div class="report-date">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
        
        <div class="report-summary">
          <div class="summary-card"><div class="summary-value">${teams.length}</div><div class="summary-label">Teams</div></div>
          <div class="summary-card"><div class="summary-value">${totalPlayers}</div><div class="summary-label">Players</div></div>
          <div class="summary-card"><div class="summary-value">${avgScore.toFixed(2)}</div><div class="summary-label">Avg Score</div></div>
          <div class="summary-card"><div class="summary-value">${balanceScore}%</div><div class="summary-label">Balance</div></div>
        </div>
        
        <div class="report-section">
          <div class="report-section-title">Team Rosters</div>
          ${teams.map((t, i) => {
            const avg = t.players.length ? (t.total / t.players.length).toFixed(2) : '0';
            return `
              <div class="report-team">
                <div class="report-team-header report-team-${i+1}">Team ${t.number} - Average: ${avg}</div>
                <div class="report-players">
                  ${t.players.map(p => `
                    <div class="report-player">
                      <div class="report-player-name">${escapeHtml(p.name)}</div>
                      <div class="report-player-score">${p.overall}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 24px;">
          <p>¬© 2025 DaenAI. All rights reserved.</p>
          <p>Contact: majid.mazouchi@gmail.com</p>
        </div>
      `;
      
      document.getElementById('reportModal').classList.add('show');
    }
    
    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('show');
    }
    
    function printReport() {
      const totalPlayers = teams.reduce((s, t) => s + t.players.length, 0);
      const avgScore = teams.reduce((s, t) => s + t.total, 0) / totalPlayers;
      const variance = calcVariance();
      const balanceScore = Math.max(0, 100 - variance * 50).toFixed(0);
      
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Volleyball Team Report</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
    .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #8b5cf6; }
    .logo { font-size: 48px; }
    .title { font-size: 24px; font-weight: bold; margin: 10px 0; }
    .subtitle { color: #666; }
    .summary { display: flex; justify-content: space-around; margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
    .summary-item { text-align: center; }
    .summary-value { font-size: 28px; font-weight: bold; color: #8b5cf6; }
    .summary-label { font-size: 12px; color: #666; }
    .section-title { font-size: 18px; font-weight: bold; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 2px solid #8b5cf6; }
    .team { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .team-header { padding: 12px 16px; color: white; display: flex; justify-content: space-between; }
    .team-1 .team-header { background: #3b82f6; }
    .team-2 .team-header { background: #8b5cf6; }
    .team-3 .team-header { background: #10b981; }
    .team-4 .team-header { background: #f97316; }
    .players { padding: 12px; display: flex; flex-wrap: wrap; gap: 10px; }
    .player { background: #f9f9f9; padding: 8px 12px; border-radius: 6px; text-align: center; min-width: 100px; }
    .player-name { font-weight: bold; }
    .player-score { color: #8b5cf6; font-weight: bold; }
    .footer { text-align: center; margin-top: 30px; color: #999; font-size: 12px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">üèê</div>
    <div class="title">Volleyball Team Report</div>
    <div class="subtitle">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
  </div>
  
  <div class="summary">
    <div class="summary-item"><div class="summary-value">${teams.length}</div><div class="summary-label">TEAMS</div></div>
    <div class="summary-item"><div class="summary-value">${totalPlayers}</div><div class="summary-label">PLAYERS</div></div>
    <div class="summary-item"><div class="summary-value">${avgScore.toFixed(2)}</div><div class="summary-label">AVG SCORE</div></div>
    <div class="summary-item"><div class="summary-value">${balanceScore}%</div><div class="summary-label">BALANCE</div></div>
  </div>
  
  <div class="section-title">üìã Team Rosters</div>
  ${teams.map((t, i) => {
    const avg = t.players.length ? (t.total / t.players.length).toFixed(2) : '0';
    return `
    <div class="team team-${i+1}">
      <div class="team-header">
        <span><strong>Team ${t.number}</strong> (${t.players.length} players)</span>
        <span>Avg: <strong>${avg}</strong></span>
      </div>
      <div class="players">
        ${t.players.map(p => `<div class="player"><div class="player-name">${escapeHtml(p.name)}</div><div class="player-score">${p.overall}</div></div>`).join('')}
      </div>
    </div>
    `;
  }).join('')}
  
  <div class="footer">¬© 2025 DaenAI | majid.mazouchi@gmail.com</div>
</body>
</html>`;
      
      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
      setTimeout(() => win.print(), 300);
    }
    
    function downloadReport() {
      const totalPlayers = teams.reduce((s, t) => s + t.players.length, 0);
      const avgScore = teams.reduce((s, t) => s + t.total, 0) / totalPlayers;
      const variance = calcVariance();
      const balanceScore = Math.max(0, 100 - variance * 50).toFixed(0);
      
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Volleyball Team Report</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #1e293b;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .report-header {
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
      color: white;
      text-align: center;
      padding: 40px 20px;
    }
    .report-logo { font-size: 64px; margin-bottom: 16px; }
    .report-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
    .report-subtitle { font-size: 16px; opacity: 0.9; }
    .report-date { font-size: 14px; opacity: 0.8; margin-top: 12px; }
    
    .report-body { padding: 32px; }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    .summary-card {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .summary-value { font-size: 32px; font-weight: 800; }
    .summary-label { font-size: 12px; text-transform: uppercase; opacity: 0.9; margin-top: 4px; }
    
    .section { margin-bottom: 32px; }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 3px solid #8b5cf6;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .team-card {
      background: #f8fafc;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .team-header {
      padding: 16px 20px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .team-1 .team-header { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .team-2 .team-header { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
    .team-3 .team-header { background: linear-gradient(135deg, #10b981, #14b8a6); }
    .team-4 .team-header { background: linear-gradient(135deg, #f97316, #fbbf24); }
    .team-name { font-size: 20px; font-weight: 800; }
    .team-avg { font-size: 24px; font-weight: 800; }
    .team-avg-label { font-size: 10px; text-transform: uppercase; opacity: 0.8; }
    
    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      padding: 16px;
    }
    .player-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }
    .player-name { font-weight: 700; font-size: 14px; color: #1e293b; }
    .player-role { font-size: 11px; color: #64748b; margin: 4px 0; }
    .player-score { font-size: 18px; font-weight: 800; color: #8b5cf6; }
    
    .footer {
      text-align: center;
      padding: 24px;
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      border-top: 1px solid #e2e8f0;
    }
    
    @media print {
      body { background: white; padding: 0; }
      .container { box-shadow: none; }
    }
    @media (max-width: 600px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="report-header">
      <div class="report-logo">üèê</div>
      <div class="report-title">Volleyball Team Report</div>
      <div class="report-subtitle">Professional Team Balancing Results</div>
      <div class="report-date">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
    </div>
    
    <div class="report-body">
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-value">${teams.length}</div>
          <div class="summary-label">Teams</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">${totalPlayers}</div>
          <div class="summary-label">Players</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">${avgScore.toFixed(2)}</div>
          <div class="summary-label">Avg Score</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">${balanceScore}%</div>
          <div class="summary-label">Balance</div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">üìã Team Rosters</div>
        ${teams.map((t, i) => {
          const avg = t.players.length ? (t.total / t.players.length).toFixed(2) : '0';
          return `
          <div class="team-card team-${i+1}">
            <div class="team-header">
              <div>
                <div class="team-name">Team ${t.number}</div>
                <div>${t.players.length} players</div>
              </div>
              <div style="text-align: right;">
                <div class="team-avg-label">Average</div>
                <div class="team-avg">${avg}</div>
              </div>
            </div>
            <div class="players-grid">
              ${t.players.map(p => `
                <div class="player-card">
                  <div class="player-name">${escapeHtml(p.name)}</div>
                  <div class="player-role">${p.role}</div>
                  <div class="player-score">${p.overall}</div>
                </div>
              `).join('')}
            </div>
          </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <div class="footer">
      <p>¬© 2025 DaenAI. All rights reserved.</p>
      <p>Contact: majid.mazouchi@gmail.com</p>
    </div>
  </div>
</body>
</html>`;
      
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `volleyball_team_report_${new Date().toISOString().split('T')[0]}.html`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Report downloaded!', 'success');
    }
    
    // Import/Export
    function exportData() {
      const data = { 
        players, 
        weights: skillWeights,
        exportDate: new Date().toISOString(), 
        version: '2.3' 
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vb_players_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Data exported!', 'success');
    }
    
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          let imported = data.players || (Array.isArray(data) ? data : []);
          if (imported.length > 0) {
            players = imported.map(p => migratePlayer(p));
            
            // Import weights if present
            if (data.weights) {
              skillWeights = { ...DEFAULT_WEIGHTS, ...data.weights };
              renderWeightsGrid();
            }
            
            saveData();
            renderPlayers();
            renderRanking();
            showToast(`Imported ${players.length} players!`, 'success');
          } else showToast('No players found', 'error');
        } catch (err) { showToast('Error reading file', 'error'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    // Utilities
    function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }
    function escapeHtml(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span> ${message}`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Initialize
    init();
  </script>
</body>
</html>
